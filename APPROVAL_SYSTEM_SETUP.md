# 🚧 슈퍼바이저 승인 시스템 설정 가이드

## 개요

임시 승인 시스템을 구현했습니다. 결제 모듈이 완성되면 쉽게 제거할 수 있도록 플래그로 관리됩니다.

## 주요 기능

1. **회원가입 시 자동 승인 요청 생성**
2. **슈퍼바이저에게 승인 요청 이메일 발송**
3. **승인 링크 클릭 시 즉시 권한 부여**
4. **승인된 사용자는 목록 0, 1번만 접근 가능**
5. **사용자에게 승인 완료 이메일 발송**

## 설정 방법

### 1. Supabase 데이터베이스 설정

`supabase_schema.sql` 파일의 `user_approvals` 테이블 생성 SQL을 Supabase에서 실행하세요:

```sql
-- supabase_schema.sql 파일의 10번 섹션 참고
```

### 2. 환경변수 설정

`.env` 파일 또는 서버 환경변수에 다음을 추가하세요:

```bash
# 이메일 발송 설정 (Gmail 사용 예시)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password  # Gmail 앱 비밀번호 사용
```

**Gmail 앱 비밀번호 생성 방법:**
1. Google 계정 설정 → 보안
2. 2단계 인증 활성화
3. 앱 비밀번호 생성
4. 생성된 비밀번호를 `SMTP_PASSWORD`에 입력

### 3. 승인 시스템 활성화/비활성화

`app.py` 파일 상단에서 플래그를 변경하세요:

```python
# 승인 시스템 활성화
SUPERVISOR_APPROVAL_ENABLED = True

# 승인 시스템 비활성화 (원래 로직으로 복귀)
SUPERVISOR_APPROVAL_ENABLED = False
```

## 사용 흐름

### 1. 사용자 회원가입
- 사용자가 회원가입을 하면 자동으로 승인 요청이 생성됩니다
- 상태: `pending`

### 2. 슈퍼바이저에게 이메일 발송
- `bunz5911@gmail.com`으로 승인 요청 이메일이 발송됩니다
- 이메일에는 승인 링크가 포함되어 있습니다

### 3. 승인 링크 클릭
- 슈퍼바이저가 이메일의 승인 링크를 클릭합니다
- 서버에서 승인 상태를 `approved`로 업데이트합니다
- 사용자에게 승인 완료 이메일이 발송됩니다

### 4. 사용자 접근
- 승인된 사용자는 목록 0번과 1번에만 접근 가능합니다
- 다른 목록을 클릭하면 접근 권한 없음 모달이 표시됩니다

## API 엔드포인트

### 승인 링크
```
GET /api/approve/<token>
```
- 승인 토큰으로 사용자를 승인합니다
- 승인 완료 페이지를 반환합니다

### 승인 상태 조회
```
GET /api/user/approval-status?user_id=<uuid>
```
- 사용자의 승인 상태를 조회합니다
- 반환값:
  - `status`: 'pending', 'approved', 'rejected', 'not_found'
  - `approved_stories`: 접근 가능한 목록 (예: "0,1")
  - `approved_at`: 승인 시간

## 승인 시스템 제거 방법

나중에 결제 모듈을 추가하고 승인 시스템을 제거하려면:

1. `app.py`에서 `SUPERVISOR_APPROVAL_ENABLED = False`로 변경
2. `app.py`에서 승인 관련 코드는 그대로 두어도 됩니다 (플래그로 비활성화됨)
3. 필요시 다음 코드 블록들을 제거할 수 있습니다:
   - `send_email()` 함수
   - `/api/approve/<token>` 엔드포인트
   - `/api/user/approval-status` 엔드포인트
   - 회원가입 시 승인 요청 생성 코드
   - 접근 권한 체크 시 승인 상태 확인 코드

## 주의사항

1. **이메일 설정 필수**: 승인 시스템이 작동하려면 SMTP 설정이 필요합니다
2. **승인 토큰 보안**: 승인 토큰은 32바이트 랜덤 문자열로 생성됩니다
3. **승인 링크 유효성**: 승인 링크는 한 번만 사용 가능합니다 (이미 승인된 경우 오류 표시)
4. **호스트 URL**: 프로덕션 환경에서는 `request.host_url`이 올바른 도메인을 반환하는지 확인하세요

## 테스트 방법

1. 테스트 계정으로 회원가입
2. 슈퍼바이저 이메일(`bunz5911@gmail.com`) 확인
3. 승인 링크 클릭
4. 승인 완료 페이지 확인
5. 테스트 계정으로 로그인하여 목록 0, 1번 접근 테스트
6. 다른 목록 클릭하여 접근 제한 확인

