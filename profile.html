<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ í”„ë¡œí•„ - Read Aloud Korean</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background: #111827; /* ë©”ì¸ ì•±ê³¼ ë™ì¼í•œ ë‹¤í¬ëª¨ë“œ ë°°ê²½ */
            min-height: 100vh;
            min-height: 100dvh; /* ë™ì  ë·°í¬íŠ¸ */
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(60px, env(safe-area-inset-bottom)); /* í•˜ë‹¨ ë„‰ë„‰í•œ ì—¬ë°± */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            color: #f9fafb; /* ë‹¤í¬ëª¨ë“œ í…ìŠ¤íŠ¸ */
        }

        .profile-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 32px;
            border-radius: 20px;
            color: white;
            margin-bottom: 24px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #1f2937; /* ë‹¤í¬ëª¨ë“œ ì•„ë°”íƒ€ ë°°ê²½ */
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .profile-name {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .profile-email {
            font-size: 15px;
            opacity: 0.9;
        }

        .section {
            background: #1f2937; /* ë‹¤í¬ëª¨ë“œ ì¹´ë“œ ë°°ê²½ */
            padding: 32px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .section-title {
            font-size: 20px;
            font-weight: 800;
            color: #f9fafb; /* ë‹¤í¬ëª¨ë“œ í…ìŠ¤íŠ¸ */
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #374151; /* ë‹¤í¬ëª¨ë“œ ë³´ë” */
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .info-card {
            background: #374151; /* ë‹¤í¬ëª¨ë“œ ì¹´ë“œ ë°°ê²½ */
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .info-label {
            font-size: 13px;
            color: #9ca3af; /* ë‹¤í¬ëª¨ë“œ í…ìŠ¤íŠ¸ */
            margin-bottom: 8px;
            font-weight: 600;
        }

        .info-value {
            font-size: 24px;
            font-weight: 800;
            color: #f9fafb; /* ë‹¤í¬ëª¨ë“œ í…ìŠ¤íŠ¸ */
        }

        .info-value.highlight {
            color: #667eea;
        }

        .plan-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .plan-badge.free {
            background: #e0e0e0;
            color: #666;
        }

        .plan-badge.pro {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .plan-badge.premier {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
        }

        .subscription-info {
            background: #374151; /* ë‹¤í¬ëª¨ë“œ ì¹´ë“œ ë°°ê²½ */
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .subscription-info p {
            font-size: 14px;
            color: #d1d5db; /* ë‹¤í¬ëª¨ë“œ í…ìŠ¤íŠ¸ */
            line-height: 1.8;
            margin-bottom: 8px;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #374151; /* ë‹¤í¬ëª¨ë“œ ë²„íŠ¼ ë°°ê²½ */
            color: #818cf8; /* ë‹¤í¬ëª¨ë“œ ë§í¬ ìƒ‰ìƒ */
            border: 2px solid #818cf8;
        }

        .btn-secondary:hover {
            background: #4b5563; /* ë‹¤í¬ëª¨ë“œ í˜¸ë²„ ë°°ê²½ */
        }

        .btn-danger {
            background: #374151; /* ë‹¤í¬ëª¨ë“œ ë²„íŠ¼ ë°°ê²½ */
            color: #fca5a5; /* ë‹¤í¬ëª¨ë“œ ì—ëŸ¬ í…ìŠ¤íŠ¸ */
            border: 2px solid #fca5a5;
        }

        .btn-danger:hover {
            background: #7f1d1d; /* ë‹¤í¬ëª¨ë“œ ì—ëŸ¬ ë°°ê²½ */
        }

        .danger-zone {
            border: 2px solid #fca5a5; /* ë‹¤í¬ëª¨ë“œ ê²½ê³  ë³´ë” */
            border-radius: 12px;
            padding: 24px;
            background: #7f1d1d; /* ë‹¤í¬ëª¨ë“œ ê²½ê³  ë°°ê²½ */
        }

        .danger-zone-title {
            font-size: 18px;
            font-weight: 800;
            color: #fca5a5; /* ë‹¤í¬ëª¨ë“œ ê²½ê³  í…ìŠ¤íŠ¸ */
            margin-bottom: 12px;
        }

        .danger-zone p {
            font-size: 14px;
            color: #d1d5db; /* ë‹¤í¬ëª¨ë“œ í…ìŠ¤íŠ¸ */
            margin-bottom: 16px;
            line-height: 1.6;
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .profile-container {
                padding: 0;
            }

            .section {
                padding: 24px 20px;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="profile-container">
        <a href="index.html" class="back-link">â† í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>

        <!-- í”„ë¡œí•„ í—¤ë” -->
        <div class="profile-header" id="profileHeader">
            <div class="loading">í”„ë¡œí•„ ë¡œë”© ì¤‘...</div>
        </div>

        <!-- í†µê³„ -->
        <div class="section">
            <div class="section-title">ğŸ“Š ë‚´ í™œë™</div>
            <div class="info-grid" id="statsGrid">
                <div class="loading">í†µê³„ ë¡œë”© ì¤‘...</div>
            </div>
        </div>

        <!-- êµ¬ë… ì •ë³´ -->
        <div class="section" id="subscriptionSection">
            <div class="section-title">ğŸ’³ êµ¬ë… ì •ë³´</div>
            <div id="subscriptionInfo">
                <div class="loading">êµ¬ë… ì •ë³´ ë¡œë”© ì¤‘...</div>
            </div>
        </div>

        <!-- ê³„ì • ê´€ë¦¬ -->
        <div class="section">
            <div class="section-title">âš™ï¸ ê³„ì • ê´€ë¦¬</div>
            
            <div class="button-group" style="margin-bottom: 32px;">
                <button class="btn btn-primary" onclick="logoutUser()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    ğŸšª ë¡œê·¸ì•„ì›ƒ
                </button>
                <button class="btn btn-secondary" onclick="location.href='pricing.html'">
                    â¬†ï¸ í”Œëœ ì—…ê·¸ë ˆì´ë“œ
                </button>
                <button class="btn btn-secondary" onclick="changePassword()">
                    ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                </button>
            </div>

            <!-- ìœ„í—˜ êµ¬ì—­ -->
            <div class="danger-zone">
                <div class="danger-zone-title">âš ï¸ ìœ„í—˜ êµ¬ì—­</div>
                <p>ì•„ë˜ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹ ì¤‘í•˜ê²Œ ê²°ì •í•´ì£¼ì„¸ìš”.</p>
                
                <div class="button-group">
                    <button class="btn btn-danger" onclick="cancelSubscription()" id="cancelSubBtn" style="display: none;">
                        êµ¬ë… í•´ì§€
                    </button>
                    <button class="btn btn-danger" onclick="deleteAccount()">
                        íšŒì› íƒˆí‡´
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ë°°í¬ í™˜ê²½ ê°ì§€: ë¡œì»¬ì—ì„œëŠ” localhost ì‚¬ìš©, í”„ë¡œë•ì…˜ì—ì„œëŠ” Cloudflare Pages API í”„ë¡ì‹œ ì‚¬ìš©
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:8080/api'
            : window.location.origin + '/api';  // Cloudflare Pages API í”„ë¡ì‹œ ì‚¬ìš©
        let currentUser = null;

        // ë¡œê·¸ì¸ ì²´í¬
        async function checkAuth() {
            const accessToken = localStorage.getItem('access_token');
            
            if (!accessToken) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!');
                location.href = 'login.html';
                return false;
            }
            
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.user) {
                    currentUser = data.user;
                    return true;
                } else {
                    alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    location.href = 'login.html';
                    return false;
                }
            } catch (error) {
                console.error('ì¸ì¦ í™•ì¸ ì˜¤ë¥˜:', error);
                alert('ì¸ì¦ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                location.href = 'login.html';
                return false;
            }
        }

        // í”„ë¡œí•„ ë¡œë“œ
        async function loadProfile() {
            if (!currentUser) return;

            const planNames = {
                'free': 'Free',
                'pro': 'Pro',
                'premier': 'Premier'
            };

            const planBadgeClass = {
                'free': 'free',
                'pro': 'pro',
                'premier': 'premier'
            };

            // í”„ë¡œí•„ í—¤ë”
            document.getElementById('profileHeader').innerHTML = `
                <div class="profile-avatar">
                    ${currentUser.avatar_url 
                        ? `<img src="${currentUser.avatar_url}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` 
                        : 'ğŸ‘¤'}
                </div>
                <div class="profile-name">${currentUser.display_name || 'ì‚¬ìš©ì'}</div>
                <div class="profile-email">${currentUser.email || ''}</div>
                <div style="margin-top: 16px;">
                    <span class="plan-badge ${planBadgeClass[currentUser.plan] || 'free'}">${planNames[currentUser.plan] || 'Free'} í”Œëœ</span>
                </div>
            `;

            // í†µê³„
            document.getElementById('statsGrid').innerHTML = `
                <div class="info-card">
                    <div class="info-label">ë³´ìœ  ì½”ì¸</div>
                    <div class="info-value highlight">ğŸŸ¡ ${currentUser.coins || 0}</div>
                </div>
                <div class="info-card">
                    <div class="info-label">ì—°ì† ì¶œì„</div>
                    <div class="info-value">ğŸ”¥ ${currentUser.current_streak || 0}ì¼</div>
                </div>
                <div class="info-card">
                    <div class="info-label">ë ˆë²¨</div>
                    <div class="info-value">Lv. ${currentUser.level || 1}</div>
                </div>
            `;

            // êµ¬ë… ì •ë³´
            loadSubscriptionInfo();
        }

        // êµ¬ë… ì •ë³´ ë¡œë“œ
        function loadSubscriptionInfo() {
            const plan = currentUser.plan || 'free';
            const cancelBtn = document.getElementById('cancelSubBtn');

            if (plan === 'free') {
                // ë¬´ë£Œ í”Œëœ
                document.getElementById('subscriptionInfo').innerHTML = `
                    <div class="subscription-info">
                        <p><strong>í˜„ì¬ í”Œëœ:</strong> Free (ë¬´ë£Œ)</p>
                        <p><strong>ë™í™” ì ‘ê·¼:</strong> 1-3ë²ˆ</p>
                        <p><strong>ì½”ì¸:</strong> 10ê°œ</p>
                        <p style="margin-top: 16px; color: #667eea; font-weight: 600;">
                            Pro ë˜ëŠ” Premierë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ì—¬ ë” ë§ì€ ë™í™”ë¥¼ í•™ìŠµí•˜ì„¸ìš”!
                        </p>
                    </div>
                    <button class="btn btn-primary" onclick="location.href='pricing.html'" style="margin-top: 16px;">
                        í”Œëœ ì—…ê·¸ë ˆì´ë“œ â†’
                    </button>
                `;
                
                if (cancelBtn) cancelBtn.style.display = 'none';
                
            } else if (plan === 'pro') {
                // Pro í”Œëœ
                document.getElementById('subscriptionInfo').innerHTML = `
                    <div class="subscription-info">
                        <p><strong>í˜„ì¬ í”Œëœ:</strong> Pro</p>
                        <p><strong>ì›” ìš”ê¸ˆ:</strong> $13.99/ì›”</p>
                        <p><strong>ë™í™” ì ‘ê·¼:</strong> 1-10ë²ˆ</p>
                        <p><strong>ì½”ì¸:</strong> 100ê°œ/ì›”</p>
                        <p><strong>ë‹¤ìŒ ê²°ì œì¼:</strong> ì¤€ë¹„ ì¤‘</p>
                        <p style="margin-top: 16px; color: #888;">
                            Toss Payments ì—°ë™ í›„ ìë™ ê²°ì œë©ë‹ˆë‹¤.
                        </p>
                    </div>
                    <div class="button-group" style="margin-top: 16px;">
                        <button class="btn btn-primary" onclick="location.href='pricing.html'">
                            Premierë¡œ ì—…ê·¸ë ˆì´ë“œ
                        </button>
                    </div>
                `;
                
                if (cancelBtn) cancelBtn.style.display = 'inline-block';
                
            } else if (plan === 'premier') {
                // Premier í”Œëœ
                document.getElementById('subscriptionInfo').innerHTML = `
                    <div class="subscription-info">
                        <p><strong>í˜„ì¬ í”Œëœ:</strong> Premier â­</p>
                        <p><strong>ì›” ìš”ê¸ˆ:</strong> $29.99/ì›”</p>
                        <p><strong>ë™í™” ì ‘ê·¼:</strong> 1-20ë²ˆ</p>
                        <p><strong>ì½”ì¸:</strong> 300ê°œ/ì›”</p>
                        <p><strong>ë‹¤ìŒ ê²°ì œì¼:</strong> ì¤€ë¹„ ì¤‘</p>
                        <p style="margin-top: 16px; color: #888;">
                            Toss Payments ì—°ë™ í›„ ìë™ ê²°ì œë©ë‹ˆë‹¤.
                        </p>
                    </div>
                `;
                
                if (cancelBtn) cancelBtn.style.display = 'inline-block';
            }
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logoutUser() {
            const confirmed = confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
            
            if (confirmed) {
                // localStorage ì •ë¦¬
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('userId');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('displayName');
                localStorage.removeItem('userPlan');
                localStorage.removeItem('lastCheckinDate');
                
                alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.href = 'index.html';
            }
        }

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
        function changePassword() {
            alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.\n\ní˜„ì¬ëŠ” ì´ë©”ì¼ë¡œ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë§í¬ë¥¼ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }

        // êµ¬ë… í•´ì§€
        async function cancelSubscription() {
            const confirmed = confirm('ì •ë§ êµ¬ë…ì„ í•´ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní•´ì§€ í›„ì—ë„ í˜„ì¬ ê²°ì œ ê¸°ê°„ ë™ì•ˆì€ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\në‹¤ìŒ ê°±ì‹ ì¼ì— ìë™ìœ¼ë¡œ Free í”Œëœìœ¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤.');
            
            if (!confirmed) return;
            
            try {
                const accessToken = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE}/subscription/cancel`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('êµ¬ë…ì´ í•´ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\n\ní˜„ì¬ ê²°ì œ ê¸°ê°„ì´ ëë‚˜ë©´ Free í”Œëœìœ¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤.');
                    location.reload();
                } else {
                    alert('êµ¬ë… í•´ì§€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('êµ¬ë… í•´ì§€ ì˜¤ë¥˜:', error);
                alert('êµ¬ë… í•´ì§€ ê¸°ëŠ¥ì€ Toss Payments ì—°ë™ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            }
        }

        // íšŒì› íƒˆí‡´
        async function deleteAccount() {
            const step1 = confirm('ì •ë§ë¡œ íšŒì› íƒˆí‡´ë¥¼ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\níƒˆí‡´ ì‹œ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            
            if (!step1) return;
            
            const step2 = prompt('íšŒì› íƒˆí‡´ë¥¼ ì§„í–‰í•˜ë ¤ë©´ "íƒˆí‡´í•˜ê² ìŠµë‹ˆë‹¤"ë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”:');
            
            if (step2 !== 'íƒˆí‡´í•˜ê² ìŠµë‹ˆë‹¤') {
                alert('ì…ë ¥ì´ ì¼ì¹˜í•˜ì§€ ì•Šì•„ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                const accessToken = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE}/account/delete`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nê·¸ë™ì•ˆ ì´ìš©í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.');
                    
                    // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
                    localStorage.clear();
                    location.href = 'index.html';
                } else {
                    alert('íšŒì› íƒˆí‡´ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('íšŒì› íƒˆí‡´ ì˜¤ë¥˜:', error);
                alert('íšŒì› íƒˆí‡´ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // ì´ˆê¸°í™”
        async function init() {
            const isAuth = await checkAuth();
            if (isAuth) {
                await loadProfile();
            }
        }

        init();
    </script>
</body>
</html>

